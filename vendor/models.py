import uuid
import random
import string

# import logging

from django.conf import settings
from django.db import models
from django.utils.translation import ugettext as _
from django.urls import reverse
from django.contrib.sites.models import Site


#############
# CURRENCIES
#############

CURRENCIES = {  'usd': {
                    'name': _('US Dollar'), 
                    'symbol':"$"},
                # 'euro': {
                #     'name': _('Euros'), 
                #     'symbol':"E"},
                # }
            }

##########
# CHOICES
##########

clist = list(CURRENCIES.keys())
clist.sort()
CURRENCY_CHOICES = tuple([(item, CURRENCIES[item]['name']) for item in clist])        #(('usd', _('US Dollar')),)
ORDER_STATS_CHOICES = ((0, _("Cart")), (10, _("Processing")), (20, _("Complete")) )


############
# UTILITIES
############

def random_string(length=8, check=[]):
    letters= string.digits + string.ascii_uppercase
    value = ''.join(random.sample(letters,length))

    if value not in check:
        return value
    return random_string(length=length, check=check)

def generate_sku(self):
    return random_string()

    
##################
# ABSTRACT MODELS
##################

class CreateUpdateModelBase(models.Model):
    created = models.DateTimeField("date created", auto_now_add=True)
    updated = models.DateTimeField("last updated", auto_now=True)

    class Meta:
        abstract = True


class ProductModelBase(CreateUpdateModelBase):
    '''
    Create your own Product models with this as the base.
    '''
    sku = models.CharField(_("SKU"), max_length=8, default=generate_sku)                 # Needs to be autogenerated by default
    uuid = models.UUIDField(default=uuid.uuid4, editable=False, unique=True)    # Used to track the product
    catalog = models.ManyToManyField('vendor.Catalog')
    msrp = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(_("Currency"), max_length=4, choices=CURRENCY_CHOICES)
    available = models.BooleanField(_("Available"), default=False, help_text="Is this currently available?")

    class Meta:
        abstract = True

    def current_price(self):
        '''
        Check if there are any price options active, otherwise use msrp.
        '''
        return self.msrp

    def price_display(self):
        return "$%s" % self.current_price()


#########
# MIXINS
#########


##########
# CATALOG
##########

class Catalog(CreateUpdateModelBase):
    '''
    List of itmes being offered.
    '''
    name = models.CharField(_("Name"), max_length=100, blank=False)
    slug = models.SlugField(_("Slug"))
    site = models.ForeignKey(Site, related_name='catalog', on_delete=models.CASCADE, help_text="Which site is this inventory available to?")

    def __str__(self):
        return "{0} - {1}".format(self.site, self.name)


class Price(models.Model):
    '''
    This is to allow an item to have multiple available prices with date ranges (for sales).
    Prices with a higher priority will override prices in the same date range with a lower priority.
    '''
    product = models.ForeignKey(settings.PRODUCT_MODEL, verbose_name=_("Product"), on_delete=models.CASCADE, related_name="sale_price")
    price = models.DecimalField(max_digits=10, decimal_places=2)
    currency = models.CharField(_("Currency"), max_length=4, choices=CURRENCY_CHOICES)
    start_date = models.DateTimeField(_("Start Date"))
    end_date = models.DateTimeField(_("End Date"))
    priority = models.PositiveIntegerField(_("Priority"), help_text="Higher number overrides prices with lower numbners in the same date range.")

    @property
    def price_display(self):
        return "$%s" % self.price


class Order(CreateUpdateModelBase):
    '''
    A Cart that forms the list of itmes purchased.
    '''
    user = models.ForeignKey(settings.AUTH_USER_MODEL, null=True, on_delete=models.SET_NULL)
    status = models.IntegerField(_("Status"), choices=ORDER_STATS_CHOICES, default=0)


class OrderItem(CreateUpdateModelBase):
    '''
    A link for each item to a user after it's been purchased
    '''
    order = models.ForeignKey(Order, on_delete=models.CASCADE)
    product = models.ForeignKey(settings.PRODUCT_MODEL, on_delete=models.CASCADE, related_name="items")
    price_paid = models.DecimalField(max_digits=10, decimal_places=2, blank=True, null=True)    # This is blank until a purchase is made.
    currency = models.CharField(_("Currency"), max_length=4, choices=CURRENCY_CHOICES)
    fullfilled = models.BooleanField(default=False)
    quantity = models.IntegerField(default=1)
    user = models.ForeignKey(settings.AUTH_USER_MODEL, null=True, on_delete=models.SET_NULL)
    # gift = models.BooleanField(dfault=False)

    def total(self):
        return self.quantity * self.price_paid


# class Library(CreateUpdateModelBase):
#     '''
#     A list of all the items a user owns.
#     '''
#     user = models.ForeignKey(settings.AUTH_USER_MODEL, null=True, on_delete=models.SET_NULL)
#     items = models.ManyToManyField(settings.PRODUCT_MODEL, verbose_name=_("Items"))


# class Wishlist(models.Model):
#     user = models.ForeignKey(settings.AUTH_USER_MODEL, null=True, on_delete=models.SET_NULL)
#     name = models.CharField(_("Name"), max_length=100, blank=False)
#     items = models.ManyToManyField(settings.PRODUCT_MODEL, verbose_name=_("Items"))


# class Discount(models.Model):
#     pass


# class GiftCode(models.Model):
#     pass
