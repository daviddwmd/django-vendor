{% extends "vendor/base.html" %}
{% load static %}

{% block extra_css %}
    {% comment %} <link rel="stylesheet" href="{% static 'css/global.css' %}" /> {% endcomment %}
    <link rel="stylesheet" href="{% static 'css/stripe.css' %}" />
{% endblock %}


{% block extra_head_js %}
  <script src="https://js.stripe.com/v3/"></script>
{% endblock %}




{% block content %}

<div class="row justify-content-md-center">
<div class="col-4">

<h2>Checkout</h2>

{% comment %} <form action="/charge" method="post" id="payment-form">
  <div class="form-row">

    <label for="card-element">
    </label>

    <div id="card-element">
      <!-- A Stripe Element will be inserted here. -->
    </div>

    <!-- Used to display form errors. -->
    <div id="card-errors" role="alert"></div>

  </div>

  <button id="card-button" data-secret="{{ client_secret }}">Submit Payment</button>
</form> {% endcomment %}

<form action="/sales/checkout/" method="post" id="payment-form">
  {% csrf_token %}
  {% comment %} <input id="card-name" type="text"> {% endcomment %}
  <!-- placeholder for Elements -->
  <label for="card-element">Card</label>
  <div id="card-element"></div>
  <div id="card-errors" role="alert"></div>
  <button id="card-button" class="btn btn-success btn-block" data-secret="{{ client_secret }}">
    Submit Payment
  </button>
</form>


  <script>
    var stripe = Stripe('{{ pub_key }}');
    var elements = stripe.elements();
    console.log("Local Vars Loaded!");
  </script>


</div>

</div>

{% comment %} <table class="table table-bordered">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">Item</th>
      <th scope="col">Price</th>
      <th scope="col">Quantity</th>
      <th scope="col">Total</th>
    </tr>
  </thead>
  <tbody>
    {% for item in object.order_items.all %}
    <tr>
      <th scope="row">{{ forloop.counter }}</th>
      <td>{{item.name}}</td>
      <td>${{item.price|floatformat:2}}</td>
      <td>{{item.quantity}}</td>
      <td>${{item.total|floatformat:2}}</td>
    </tr>
    {% endfor %}
    <tr>
      <td colspan=3></td>
      <td>Subtotal</td>
      <td>${{ object.subtotal|floatformat:2 }}</td>
    </tr>
    <tr>
      <td colspan=3></td>
      <td>Sales Tax</td>
      <td>{% if object.tax == None %}TBD{% else %}${{ object.tax|floatformat:2 }}{% endif %}</td>
    </tr>
    <tr>
      <td colspan=3></td>
      <td>Shipping</td>
      <td>{% if object.shipping == None %}TBD{% else %}${{ object.shipping|floatformat:2 }}{% endif %}</td>
    </tr>
    <tr>
      <td colspan=3></td>
      <td>Total</td>
      <td>{% if object.total == None %}TBD{% else %}${{ object.total|floatformat:2 }}{% endif %}</td>
    </tr> 

  </tbody>


</table> {% endcomment %}

{% comment %} <a href="{% url 'vendor:purchase' %}" class="btn btn-success">Purchase</a> {% endcomment %}
{% comment %} <a href="#" class="btn btn-success">Purchase</a> {% endcomment %}
{% comment %} <script src="{% static 'js/script.js' %}" defer></script> {% endcomment %}


{% endblock %}



{% block extra_js %}
    {% comment %} <script src="{% static 'js/client.js' %}" defer></script> {% endcomment %}
    {% comment %} <script src="https://js.stripe.com/v3/"></script> {% endcomment %}
    {% comment %} <script src="{% static 'js/script.js' %}"></script> {% endcomment %}

<script>

var style = {
  base: {
    color: "#32325d",
  }
};

var card = elements.create("card", { style: style });
card.mount("#card-element");

console.log("Client JS Loaded!");
</script>

<script>
{% comment %} cardElement.on('change', function(event) {
  var displayError = document.getElementById('card-errors');
  if (event.error) {
    displayError.textContent = event.error.message;
  } else {
    displayError.textContent = '';
  }
}); {% endcomment %}

card.on('change', ({error}) => {
  const displayError = document.getElementById('card-errors');
  if (error) {
    displayError.textContent = error.message;
  } else {
    displayError.textContent = '';
  }
});
</script>

<script>
var form = document.getElementById('payment-form');

form.addEventListener('submit', function(ev) {
  ev.preventDefault();
  stripe.confirmCardPayment("{{ client_secret }}", {
    payment_method: {
      card: card,
      billing_details: {
        name: 'Jenny Rosen'
      }
    }
  }).then(function(result) {
    if (result.error) {
      // Show error to your customer (e.g., insufficient funds)
      console.log(result.error.message);
    } else {
      // The payment has been processed!
      if (result.paymentIntent.status === 'succeeded') {
        // Show a success message to your customer
        // There's a risk of the customer closing the window before callback
        // execution. Set up a webhook or plugin to listen for the
        // payment_intent.succeeded event that handles any business critical
        // post-payment actions.
      }
    }
  });
});
</script>






{% comment %} <script src="{% static 'js/client.js' %}" defer></script> {% endcomment %}


{% comment %} <script>
// Set your publishable key: remember to change this to your live publishable key in production
// See your keys here: https://dashboard.stripe.com/account/apikeys
var stripe = Stripe('pk_test_51Gx4h1JjRkl6Em6f9NLaLN2rHBzjmF9EytSZX9xNyVuKuaud0jmKcl97i8FThsaqSLB81hIjgzWHggDqFo25Xceu00Q626doG8');
var elements = stripe.elements();
</script> {% endcomment %}
{% endblock %}